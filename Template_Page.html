<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Data Visualization Project</title>
    <link rel="stylesheet" href="project.css">
</head>

<script src='https://d3js.org/d3.v5.min.js'></script>

<body onload='init()'>

<header>
    <h1>Exploration of Operational Risk of USAF Primary Pilot Training Sorties</h1>
</header>

<p id="Body-Paragraph">
    Before every flight, pilots use a form to assign numerical values for risk factors.
    This risk factors range from the mission being flown (ie: students first flight), weather (ie: low cloud layers),
    and human factors (ie: lack of sleep and ops tempo)
</p>

<p id="Body-Paragraph2">The below chart is an aggregation of approximately 6 months of data from
    November 2021 to July 2022</p>

<div style="margin:0 auto;width:50%;">

    <button type="button" class="button" id="Back" onclick="window.location.href='https://radar-8.github.io/Page_3';">Back</button>

    <button type="button" class="button" id="View_1" onclick="window.location.href='https://radar-8.github.io/index';">1</button>

    <button type="button" class="button" id="View_2" onclick="window.location.href='https://radar-8.github.io/Page_2';">2</button>

    <button type="button" class="button" id="View_3" onclick="window.location.href='https://radar-8.github.io/Page_3';">3</button>

    <button type="button" class="button" id="View_4" onclick="window.location.href='https://radar-8.github.io/Page_4';">4</button>

    <button type="button" class="buttonPage" id="View_5" onclick="window.location.href='https://radar-8.github.io/Page_5';">5</button>

</div>

<div><p> </p></div>

<div><svg>
</svg><p id="averageValues">Mouse over to see the average on a Day.</p></div>
<div name="tooltip" opacity="0"></div>
<div style="margin:0 auto;width:50%;">

    <button type="button" class="button" id="Moderate" onclick="Moderate_Line(event, 10)">Moderate Line</button>

    <button type="button" class="button" id="High" onclick="High_Line(event, 16)">High Line</button>

</div>

<script>
    async function init(){
        const data = await d3.csv("https://radar-8.github.io/NOV2-JUL14.csv", d =>({
            date: new Date(d.TO_Date),
            MissionTotal: Number(d.Mission_Total),
            WeatherTotal: Number(d.Weather_Total),
            HumanTotal: Number(d.Human_Factors_Total),
            OverallTotal: Number(d.Overall_Total),
        }));

        //process data and make into a usable format
        window.dayAverage = Object.values(data.reduce(function (r, o) {
            var key = ['date'].map(k => o[k]);
            r[key] = r[key] || {
                date: o.date,
                count: 0,
                overallSum: 0,
                missionSum: 0,
                weatherSum: 0,
                humanSum: 0,
                high: 0,
                low: 100};

            r[key].overallSum += o.OverallTotal;
            r[key].missionSum += o.MissionTotal;
            r[key].weatherSum += o.WeatherTotal;
            r[key].humanSum += o.HumanTotal;
            r[key].count++;
            if (r[key].high < o.OverallTotal) {
                r[key].high = o.OverallTotal
            }
            if (r[key].low > o.OverallTotal) {
                r[key].low = o.OverallTotal
            }
            return r;
        }, {})).map(({date, count, overallSum, missionSum, weatherSum, humanSum}) =>
            ({date, overallAve: overallSum / count,
                missionAve: missionSum / count,
                weatherAve: weatherSum / count,
                humanAve: humanSum / count}));

        startDay = d3.min(dayAverage, d => d.date);
        endDay = d3.max(dayAverage, d => d.date);
        highest_average = d3.max(dayAverage, d => d.overallAve)

        window.HighLevel = 16;
        if (window.HighLevel + 2 > highest_average){
            highest_average = window.HighLevel + 2;
        }

        window.margins = {top: 10, right: 30, bottom: 30, left: 60};
        window.width = 660 - margins.left - margins.right;
        window.height = 400 - margins.top - margins.bottom;

        xdomain = [startDay, endDay];
        ydomain = [0, highest_average];
        xrange = [0,width];
        yrange = [height,0];

        window.xs = d3.scaleTime().domain(xdomain).range(xrange);
        window.ys = d3.scaleLinear().domain(ydomain).range(yrange);
        window.colors = d3.scaleOrdinal().domain(["overall", "mission", "weather", "human"]).range(["black", "lightblue", "yellow", "orange"])
        //window.colorstest = d3.scaleThreshold().domain([0,5,10]).range(["#ccc", 'green', 'orange', 'red']);
        //set svg width and height
        d3.select('svg')
            .attr("width", width + margins.left + margins.right)
            .attr("height", height + margins.top + margins.bottom)

        d3.select("svg").append("g").attr("transform", "translate("+margins.left +","+ margins.top + ")").call(d3.axisLeft(ys));
        d3.select("svg").append("g").attr("transform", "translate("+margins.left+", " + (height + margins.top) + ")").call(d3.axisBottom(xs));

        overallLine(window.dayAverage, "black");
        //missionLine(window.dayAverage, "green");
        //weatherLine(window.dayAverage, "yellow");
        //humanLine(window.dayAverage, "red");

        var mouseG = d3.select('svg')
            .append("g")
            .attr("transform", "translate("+margins.left+", " + margins.top + ")")
            .attr("class", "mouse-over-effects")

        mouseG.append('path')
            .attr("class", "mouse-line")
            .style("stroke", "black")
            .style("stroke-width", "1px")
            .style("opacity", "0");

        var mousePerLine = mouseG.selectAll('.mouse-per-line')
            .data(window.dayAverage)
            .enter()
            .append("g")
            .attr("class", "mouse-per-line");

        mousePerLine.append("circle")
            .attr("r", 7)
            .style("stroke", function(d) {
                return "black";
            })
            .style("fill", "none")
            .style("stroke-width", "1px")
            .style("opacity", "0");

        mouseG.append('svg:rect')
            .attr('width', window.width)
            .attr('height', window.height)
            .attr('fill', 'none')
            .attr('pointer-events', 'all')
            .on('mouseout', function() {
                d3.select(".mouse-line")
                    .style("opacity", "0");
            })
            .on('mouseover', function() {
                d3.select(".mouse-line")
                    .style("opacity", "1");
            })
            .on('mousemove', function() {
                var mouse = d3.mouse(this);
                d3.select(".mouse-line")
                    .attr("d", function () {
                        var d = "M" + mouse[0] + "," + window.height;
                        d += " " + mouse[0] + "," + 0;
                        return d;
                    });
                xDate = new Date(xs.invert(mouse[0]))
                window.dayAverage.forEach( v => {
                    if (v.date.getTime() === xDate.getTime()){
                        displayAverages(v, "temp");
                    }
                });
            });
    }

    function displayAverages(data, type){
        //helper function
        function roundNumber(num, dec) {
            return Math.round(num * Math.pow(10, dec)) / Math.pow(10, dec);
        }
        d3.select("#averageValues").html(roundNumber(data.overallAve, 3));
        d3.select("#averageValues").html(
            'Overall Average: ' + roundNumber(data.overallAve, 3) + '<br>' +
            'Mission Average: ' + roundNumber(data.missionAve, 3) + '<br>' +
            'Weather Average: ' + roundNumber(data.weatherAve, 3) + '<br>' +
            'Human Factors Average: ' + roundNumber(data.humanAve, 3));
    }

    function overallLine(data, color){
        d3.select("svg").append("g").attr("transform", "translate("+margins.left +","+ margins.top + ")")
            .append("path").datum(data)
            .attr("fill", "none")
            .attr("class", "line")
            .attr("stroke", color)
            .attr("stroke-width", 1.5)
            .attr("d", d3.line().x(function(d) {return xs(d.date);})
                .y(function (d) {return ys(d.overallAve);})
            )
    }

    function missionLine(data, color){
        d3.select("svg").append("g").attr("transform", "translate("+margins.left +","+ margins.top + ")")
            .append("path").datum(data)
            .attr("fill", "none")
            .attr("stroke", color)
            .attr("stroke-width", 1.5)
            .attr("d", d3.line().x(function(d) {return xs(d.date);})
                .y(function (d) {return ys(d.missionAve);})
            )
    }

    function weatherLine(data, color){
        d3.select("svg").append("g").attr("transform", "translate("+margins.left +","+ margins.top + ")")
            .append("path").datum(data)
            .attr("fill", "none")
            .attr("stroke", color)
            .attr("class", "line")
            .attr("stroke-width", 1.5)
            .attr("d", d3.line().x(function(d) {return xs(d.date);})
                .y(function (d) {return ys(d.weatherAve);})
            )
    }

    function humanLine(data, color){
        d3.select("svg").append("g").attr("transform", "translate("+margins.left +","+ margins.top + ")")
            .append("path").datum(data)
            .attr("fill", "none")
            .attr("class", "line")
            .attr("stroke", color)
            .attr("stroke-width", 1.5)
            .attr("d", d3.line().x(function(d) {return xs(d.date);})
                .y(function (d) {return ys(d.humanAve);})
            )
    }

    function Moderate_Line(event, level){
        d3.select("svg").html = "";

        d3.select("svg").append("g").attr("transform", "translate("+margins.left +","+ margins.top + ")")
            .append("line")
            .attr("fill", "none")
            .attr("stroke", "orange")
            .attr("stroke-width", 1.5)
            .attr("x1", window.margins.left)
            .attr("x2", window.width)
            .attr("y1", window.ys(level))
            .attr("y2", window.ys(level))

        missionLine(window.dayAverage, "gray")
        weatherLine(window.dayAverage, "gray")
        overallLine(window.dayAverage, "gray")
        humanLine(window.dayAverage, "gray")
    }

    function High_Line(event, level) {

        d3.select("svg").append("g").attr("transform", "translate(" + margins.left + "," + margins.top + ")")
            .append("line")
            .attr("fill", "none")
            .attr("stroke", "red")
            .attr("stroke-width", 1.5)
            .attr("x1", window.margins.left)
            .attr("x2", window.width)
            .attr("y1", window.ys(level))
            .attr("y2", window.ys(level))
    }


</script>

</body>
</html>